<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Visualisation HIT</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <style>
  .hidden {
  display: none !important;
}
body {
  overflow: visible; /* ou auto, mais pas hidden */
  font-family: 'Roboto', sans-serif;
  font-size: 14px;
  background-color: #f4f4f9;
  color: #333;
  margin: 20px;
  padding-top: 110px; /* Ajuste selon la hauteur rÃ©elle de #controls */
}

#controls {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  background: #fff;
  padding: 15px 20px;
  border-bottom: 1px solid #ccc;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  display: flex;
  flex-wrap: wrap;
  gap: 10px 15px;
  align-items: center;
}

#controls input[type="file"],
#controls input[type="text"],
#controls button {
  padding: 6px 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 13px;
}

#controls button {
  background-color: #007bff;
  color: white;
  cursor: pointer;
  transition: background 0.2s ease;
}

#controls button:hover {
  background-color: #0056b3;
}



#hitContainer {
  margin-left: 15cm;
}

#informations {
  position: fixed;
  display: none;
  top: 120px;
  left: 0.5cm;
  width: 14cm;
  min-height: 50px;
  max-height: 400px;
  background: #f1f1f1;
  padding: 18px 13px;
  border: 3px solid #888;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  font-size: 14px;
  z-index: 999;
  overflow: hidden; /* ðŸš« aucune scrollbar */
  line-height: 1.4;
  overflow: hidden;
}




/* Bloc ASIN */
.asin-block {
  display: flex;
  top:20px;
  align-items: flex-start;
  border: 2px solid #999;
  font-size: 15px;
  border-left: 6px solid #888;
  padding: 14px;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(50, 50, 50, 0.3);
  gap: 15px;
  width: 100%;
}

/* Infos produit */
.asin-info {
  width: 300px;
  font-weight: bold;
  font-size: 14px;
  color: #333;
}

/* Image produit */
.preview-img {
  width: 4cm;
  height: 4cm;
  object-fit: contain;
  cursor: pointer;
  margin-top: 6px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

/* Colonnes juges et travailleurs */
.worker-column {
  min-width: 110px;
  max-width: 110px;
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 12px;
  text-align: center;
  padding: 6px;
}

.worker-column.judge {
  align-items: flex-start;
  padding: 8px 12px;
  background-color: #fafafa;
  border-right: 1px solid #eee;
  min-width: 160px;
  max-width: 240px;
}

.checkbox-group {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
  font-size: 12px;
}

.checkbox-group label {
  display: flex;
  align-items: center;
  gap: 6px;
  margin: 0;
  margin-bottom: 3px;
  font-weight: normal;
  font-size: 11.5px;
  white-space: nowrap;
}

.majority {
  background-color: #d4edda;
  padding: 2px 4px;
  border-radius: 4px;
  margin-bottom: 2px;
}

.minority {
  background-color: #f8d7da;
  border: 1px solid #f5c2c7;
  color: #842029;
  padding: 2px 4px;
  border-radius: 4px;
  margin-bottom: 2px;
}

textarea {
  margin-top: 5px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 12px;
  padding: 4px;
  width: 100%;
  resize: vertical;
  min-height: 40px;
}

label select {
  margin-top: 2px;
  padding: 3px;
  font-size: 12px;
}

#floatingASINCanvas {
  position: fixed;
  top: 50px;
  right: 20px;
  z-index: 9999;
  cursor: move;
  border: 2px solid #444;
  background: white;
  display: none;
}

#floatingQueryWrapper.dragging {
  cursor: move;
}
#floatingQueryWrapper {
  cursor: move;
  touch-action: none;         /* Important pour Ã©viter les effets "glissants" */
  user-select: none;          /* EmpÃªche la sÃ©lection de texte ou image */
  position: fixed !important;
  top: 10px;
  left: 10px;
  width: 400px;
  z-index: 9999;
  background-color: white;
  display: none;
  border: 2px solid #ccc;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

#floatingQueryImage {
  width: 100%;
  display: block;
  transition: transform 0.3s ease;
  cursor:move;
}

#queryBBox {
  position: absolute;
  border: 2px solid red;
  background-color: rgba(255, 0, 0, 0.2);
  display: none;
  pointer-events: none;
  z-index: 10;
}

.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background-color: #333;
  color: white;
  padding: 10px 14px;
  border-radius: 6px;
  z-index: 10000;
  font-size: 13px;
  opacity: 0.9;
}

#progressOverlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255, 255, 255, 0.85);
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  backdrop-filter: blur(3px);
}

#progressBox {
  text-align: center;
  background: white;
  padding: 20px 30px;
  border-radius: 20px;
  box-shadow: 0 0 15px rgba(0,0,0,0.3);
}

#progressText {
  font-weight: bold;
  font-size: 18px;
}

.judge-title {
  font-weight: bold;
  font-size: 12px;
  margin-bottom: 6px;
  color: #333;
  text-align: left;
}

#automatisme {
  background-color: #fff4e5;       /* fond lÃ©ger orange pÃ¢le */
  border: 2px solid #ff9900;       /* bordure orange vif */
  color: #663300;                  /* texte marron foncÃ© */
  font-weight: bold;
  padding: 8px 12px;
  border-radius: 6px;
  width: 100%;
  max-width: 500px;
  box-sizing: border-box;
  user-select: none;               /* dÃ©sactive la sÃ©lection texte */
  cursor: not-allowed;             /* curseur interdit (visuel dâ€™avertissement) */
  transition: background-color 0.3s ease;
}

/* Si on veut permettre quand mÃªme la modification au focus */
#automatisme:focus {
  background-color: #fff8dc;       /* un peu plus clair au focus */
  cursor: text;                   /* curseur normal de saisie */
  user-select: text;              /* selection possible */
  outline: none;
  border-color: #ff6600;          /* bordure orange plus vif */
}

/* Notification verte centrÃ©e */
#notification {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: #d4edda;  /* vert clair */
  color: #155724;             /* vert foncÃ© */
  padding: 15px 30px;
  border: 1.5px solid #c3e6cb;
  border-radius: 8px;
  font-weight: bold;
  font-size: 16px;
  z-index: 100000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s ease;
}
#notification.show {
  opacity: 1;
  pointer-events: auto;
}

#btnSaveData1{
  position: fixed;
  bottom: 40px;
  Right: 0%;
  transform: translateX(-50%);
  background-color: #28a745;
  color: white;
  font-size: 18px;
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  z-index: 1000;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}
#btnSaveData2 {
  position: fixed;
  bottom: 40px;
  left: 100px;
  transform: translateX(-50%);
  background-color: #28a745;
  color: white;
  font-size: 18px;
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  z-index: 1000;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

#done:hover, #btnSaveData2:hover {
  background-color: #218838;
}
#done {
  display: none;
}

#btnSaveData {
  display: none;
}
#btnSaveData, #btnSaveData1 {
  background-color: #dc3545;
  color: white;
}

#btnSaveData:hover, #btnSaveData1:hover {
  background-color: #c82333;
}


#controls {
  transition: transform 0.3s ease-in-out;
}

#controls.hidden {
  transform: translateY(-100%);
}

#tableauResultat {
  width: 100%;
  border-collapse: collapse;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  font-size: 13px;
  table-layout: fixed; /* Important pour que overflow fonctionne */
}

#tableauResultat th {
  background-color: #000;
  color: #fff;
  padding: 8px;
  text-align: left;
  border: 1px solid #ddd;
}

#tableauResultat td {
  padding: 6px 8px;
  border: 1px solid #ddd;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

#tableauResultat tr:nth-child(even) {
  background-color: #f9f9f9;
}

#tableauResultat tr:hover {
  background-color: #f1f1f1;
}



element.style {
    color: rgb(0, 102, 204);
    font-size: 15px;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
</head>
<body>
<button id="toggleControlsBtn" style="position:fixed; top:3px; right:10px; z-index:10001;">â–²</button>

  <div id="controls">
    <input type="file" id="tsvInput" accept=".tsv" />
    <label for="hitIdInput">HITId :</label>
	<input type="text" id="hitIdInput" placeholder="Tapez ou collez un HITId ici" autocomplete="off" style="width: 300px;" />
    <button id="btnShowHIT">Afficher</button>
	<button id="done">Terminer</button>
	<button id="btnSaveData">Terminer => Google Sheet</button>
	<label for="sheetUrlInput">URL Google Sheet cible :</label>
    <input type="text" id="sheetUrlInput" placeholder="Entrez l'URL du fichier Google Sheet" style="width: 400px;" />
	<button id="verifierdata">Verifier</button>
	<p id="verifMessage"></p>
	<input type="text" id="automatisme" placeholder="URL de votre script Apps Script (https://script.google.com/macros/s/...)">


	<div id="msgBox"></div>
  </div>

  <div id="hitContainer"></div>
  
  
<!-- ðŸŸ¡ Overlay sablier + progression -->
<div id="progressOverlay"
     style="display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            pointer-events: all;
            backdrop-filter: blur(3px);">
  <div id="progressBox"
       style="text-align: center;
              background: white;
              padding: 20px 30px;
              border-radius: 20px;
              box-shadow: 0 0 15px rgba(0,0,0,0.3);">
    <div class="icon" style="margin-bottom: 15px;">
      <img src="vercel_sablier.gif"
           alt="Chargement..." width="120">
    </div>
    <div id="progressText" style="font-weight: bold; font-size: 18px;">Chargement...</div>
  </div>
</div>

<!-- Flottant en haut Ã  droite -->
 <div id="floatingQueryWrapper">
    <div id="queryRotatableWrapper" style="position: relative; width: fit-content;">
      <img id="floatingQueryImage" src="" alt="Image Query" style="display: block; max-width: 100%;" />
      <div id="queryBBox"></div>
    </div>
  </div>

<!-- âœ… Notification qui disparaÃ®t -->
<div id="notifMessage" class="notification" style="display:none;"></div>

</body>
<div id="informations">
  <h3>ðŸ“Œ Informations</h3>
  <p>Ici, tu peux mettre des dÃ©tails complÃ©mentaires.</p>
</div>
  <canvas id="floatingASINCanvas"></canvas>

<div class="table-wrapper" display="none">
<table id="tableauResultat" style="width: 100%; border-collapse: collapse; margin-bottom: 20px; display: none;">
  <thead>
    <tr>
      <th>hitid</th>
      <th>AssignmentId</th>
      <th>workerid</th>
      <th>Input.imageURL</th>
      <th>Input.bbox</th>
      <th>Input.content</th>
      <th>Answer.output_data</th>
      <th>amazon.image</th>
      <th>Marketplace</th>
      <th>Input.matches</th>
      <th>key</th>
      <th>assin_json</th>
      <th>assin_juge_json</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
  </div>
    <!-- Les lignes seront ajoutÃ©es ici dynamiquement -->
  </tbody>
</table>
<button id="btnSaveData1">Terminer => Google Sheet</button>
<button id="btnSaveData2">Terminer</button>

<div id="progressOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#ffffffcc; z-index:9999; justify-content:center; align-items:center; flex-direction:column;">
  <div id="progressBox">
    <div class="icon">
      <img src="https://cdn.pixabay.com/animation/2023/03/12/21/17/21-17-57-902_512.gif" alt="Chargement..." width="180">
    </div>
    <div id="progressText" style="font-weight:bold; font-size:18px;">Chargement...</div>
  </div>
</div>
<div id="notification"></div>
</body>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="papaparse_rado.js"></script>
  <script>
// VARIABLES GLOBALES
let currentHitRow = null; // accessible partout
let ATTRIBUTES = [];      // sera dÃ©fini dynamiquement selon le type
const allTitles = []; // Ã  dÃ©finir en dehors, scope global ou dans showHitid

let tsvDataRaw = [];
let currentFileName = "";

document.getElementById('tsvInput').addEventListener('change', function (e) {
  const file = e.target.files[0];
  if (!file) return;

  currentFileName = file.name;
  
  const lastStoredFile = localStorage.getItem("lastFileName");
  
  const sheetUrlInput = document.getElementById("sheetUrlInput");

	sheetUrlInput.addEventListener("input", () => {
	  localStorage.setItem("last_URL_Sheet_DA", sheetUrlInput.value.trim());
	});

  if (lastStoredFile !== currentFileName) {
    // Nouveau fichier chargÃ© -> suppression donnÃ©es de jugement + commentaires
    localStorage.removeItem("judgeAnswers");

    // Suppression commentaires liÃ©s
    Object.keys(localStorage).forEach(k => {
      if (k.startsWith("comment_")) localStorage.removeItem(k);
    });

    localStorage.setItem("lastFileName", currentFileName);
    localStorage.removeItem("currentHitId"); // on efface l'ancien HITId sauvegardÃ©
  }

Papa.parse(file, {
  header: true,
  delimiter: '\t',
  complete: function (results) {
    tsvDataRaw = results.data;
    showNotification("Fichier chargÃ© avec succÃ¨s !");


    // ðŸ” Extraction et concatÃ©nation de toutes les rÃ©ponses (minuscules)
    const allAnswers = tsvDataRaw.map(r => r['Answer.output_data']).filter(Boolean);
    let contenuConcat = allAnswers.join(" ").toLowerCase();

    // ðŸ§© Liste attributs spÃ©cifiques "Fourniture"
    const FOURNITURE_ATTRS = [
      "support_type", "shape", "extra_features", "color",
      "wrong_age_group", "material", "location", "pattern"
    ];

    // ðŸ”Ž DÃ©tection des attributs par type
    const hasFourniture = FOURNITURE_ATTRS.some(attr => contenuConcat.includes(attr));
    const hasRelevanceLabel = contenuConcat.includes("relevance_label");

    // ðŸŽ¯ Variables pour le type et la couleur fond
    let detectedType = '';
    let backgroundColor = '';
    let baseAttributes = [];

    if (hasFourniture && hasRelevanceLabel) {
      detectedType = "FR IRR"; // Fourniture avec relevance_label
	  window.detectedType = detectedType;
      backgroundColor = '#d1c4e9'; // violet clair (modifiable)
      baseAttributes = [
        "asin_image_not_load", "no_difference", "wrong_category", "wrong_age_group",
        "has_product_difference", "is_wrong_packaging_overlay", "support_type", "shape",
        "size", "extra_features", "color", "material", "location", "pattern", "relevance_label"
      ];
    } else if (hasFourniture && !hasRelevanceLabel) {
      detectedType = "FR"; // Fourniture simple
	  window.detectedType = detectedType;
      backgroundColor = '#f2f0f0'; // gris clair (modifiable)
      baseAttributes = [
        "asin_image_not_load", "no_difference", "wrong_category", "wrong_age_group",
        "has_product_difference", "is_wrong_packaging_overlay", "support_type", "shape",
        "size", "extra_features", "color", "material", "location", "pattern"
      ];
    } else if (!hasFourniture && hasRelevanceLabel) {
      detectedType = "CS IRR"; // CS avec relevance_label
	  window.detectedType = detectedType;
      backgroundColor = '#bbdefb'; // bleu clair (modifiable)
      baseAttributes = [
        "asin_image_not_load", "no_difference", "wrong_category",
        "has_product_difference", "is_wrong_characteristic",
        "is_wrong_size_or_count", "is_wrong_bundle", "is_wrong_packaging_overlay", "relevance_label"
      ];
    } else {
      detectedType = "CS"; // CS simple
	  window.detectedType = detectedType;
      backgroundColor = '#e6f7ff'; // bleu trÃ¨s clair (modifiable)
      baseAttributes = [
        "asin_image_not_load", "no_difference", "wrong_category",
        "has_product_difference", "is_wrong_characteristic",
        "is_wrong_size_or_count", "is_wrong_bundle", "is_wrong_packaging_overlay"
      ];
    }

    ATTRIBUTES = baseAttributes;
    document.body.style.backgroundColor = backgroundColor;

    //console.log("ðŸ” Type dÃ©tectÃ© :", detectedType);
    //console.log("ðŸ“¦ Attributs utilisÃ©s :", ATTRIBUTES);
	// âœ… Si nouveau fichier â†’ on affiche automatiquement le 1er HIT
    if (lastStoredFile !== currentFileName) {
      const firstValidRow = tsvDataRaw.find(r => r.HITId); // on sÃ©curise
      if (firstValidRow) {
        const firstHitId = firstValidRow.HITId;
        document.getElementById('hitIdInput').value = firstHitId;
        setTimeout(() => showHIT(firstHitId), 100);
      }
    }

    // ðŸŽ¯ Recharger automatiquement le HITId prÃ©cÃ©dent si prÃ©sent
    const lastHitId = localStorage.getItem("currentHitId");
    if (lastHitId) {
      document.getElementById('hitIdInput').value = lastHitId;
      setTimeout(() => showHIT(lastHitId), 100);
    }
  }
});


});

function updateHitIdList() {
  const select = document.getElementById('hitIdInput');
  select.innerHTML = ''; // Vide le select

  const hitIdSet = new Set();
  tsvDataRaw.forEach(row => {
    if (row.HITId) {
      const hitId = row.HITId.trim();
      if (!hitIdSet.has(hitId)) {
        hitIdSet.add(hitId);
        const option = document.createElement('option');
        option.value = hitId;
        option.textContent = hitId;  // Affiche le texte visible
        select.appendChild(option);
      }
    }
  });

  // Si un HITId est dÃ©jÃ  stockÃ© dans localStorage, on le sÃ©lectionne
  const currentHitId = localStorage.getItem("currentHitId");
  if (currentHitId && hitIdSet.has(currentHitId)) {
    select.value = currentHitId;
  } else {
    select.selectedIndex = -1; // Pas de sÃ©lection par dÃ©faut
  }
}

///ICI LE CODE DE CLICK BOUTON Afficher
document.getElementById('btnShowHIT').addEventListener('click', () => {
  const newHitId = document.getElementById('hitIdInput').value.trim();
  if (!newHitId) return alert("Aiza ze Hitid f'ahoana hozy Enao?");
  if (!tsvDataRaw.length) return alert("F'angah tsy nampiakatra  TSV aloha f'ahoana hozy Enao?");

  // Suppression commentaires non liÃ©s au nouveau HITId
  Object.keys(localStorage).forEach(k => {
    if (k.startsWith("comment_") && !k.includes(newHitId)) {
      localStorage.removeItem(k);
    }
  });

  // Sauvegarde HITId courant
  localStorage.setItem("currentHitId", newHitId);

  showHIT(newHitId);
});

///MIFARANA ETO LE CODE DE CLICK BOUTON Afficher

// Affichage automatique au changement ou saisie dans le champ HITId


function showHIT(hitId) {
  const hitContainer = document.getElementById('hitContainer');
hitContainer.innerHTML = '';

const rows = tsvDataRaw.filter(r => r.HITId === hitId);
if (!rows.length) return;

currentHitRow = rows[0];
localStorage.setItem("currentHitId", hitId);
const savedJudgeAnswers = JSON.parse(localStorage.getItem("judgeAnswers") || '{}');

// ======== Affichage BBOX et image ========
const queryImg = document.getElementById("floatingQueryImage");
const queryBBox = document.getElementById("queryBBox");
const queryWrapper = document.getElementById("floatingQueryWrapper");

queryImg.src = rows[0]['Input.imageURL'];
queryWrapper.style.display = "block";

// ðŸ†• Reset transform
queryWrapper.style.transform = 'translate(0px, 0px) scale(1) rotate(0deg)';
queryWrapper.dataset.x = 0;
queryWrapper.dataset.y = 0;
queryWrapper.dataset.scale = 1;
queryWrapper.dataset.rotation = 0;

queryImg.onload = () => {
  let bbox;
  try {
    const bboxRaw = rows[0]['Input.bbox'];
    bbox = typeof bboxRaw === 'string' ? JSON.parse(bboxRaw) : bboxRaw;
    //console.log("âœ… BBOX dÃ©tectÃ©e :", bbox);
  } catch (e) {
    console.warn("âŒ Bounding box invalide:", rows[0]['Input.bbox']);
    bbox = null;
  }

  const scaleX = queryImg.clientWidth / queryImg.naturalWidth;
  const scaleY = queryImg.clientHeight / queryImg.naturalHeight;

  let x, y, width, height;

  if (bbox && typeof bbox.tlx === 'number' && typeof bbox.brx === 'number' &&
      typeof bbox.tly === 'number' && typeof bbox.bry === 'number') {
    x = bbox.tlx;
    y = bbox.tly;
    width = bbox.brx - bbox.tlx;
    height = bbox.bry - bbox.tly;
  } else {
    console.warn("âš ï¸ BBOX invalide ou absente. Valeur de test utilisÃ©e.");
    x = 50; y = 50; width = 120; height = 80;
  }

  queryBBox.style.left = `${x * scaleX}px`;
  queryBBox.style.top = `${y * scaleY}px`;
  queryBBox.style.width = `${width * scaleX}px`;
  queryBBox.style.height = `${height * scaleY}px`;
  queryBBox.style.display = 'block';
};


// ======== ðŸ†• Zoom via molette ========
queryWrapper.addEventListener('wheel', (e) => {
  e.preventDefault();
  const delta = Math.sign(e.deltaY);
  let scale = parseFloat(queryWrapper.dataset.scale) || 1;
  scale += delta * -0.1;
  scale = Math.min(Math.max(0.5, scale), 3);

  const x = parseFloat(queryWrapper.dataset.x) || 0;
  const y = parseFloat(queryWrapper.dataset.y) || 0;
  const rotation = parseFloat(queryWrapper.dataset.rotation) || 0;

  queryWrapper.style.transform = `translate(${x}px, ${y}px) scale(${scale}) rotate(${rotation}deg)`;
  queryWrapper.dataset.scale = scale;
});


// ======== PrÃ©paration liste ASIN ========
const asinSet = new Set();
rows.forEach(row => {
  const matchArray = parseFixedJSON(row['Input.matches'] || '[]');
  matchArray.forEach(match => asinSet.add(match.asin));
});
const asinList = Array.from(asinSet);

asinList.forEach(asin => {
  const asinBlock = document.createElement('div');
  asinBlock.className = 'asin-block';
  const index = asinList.indexOf(asin);
  asinBlock.style.backgroundColor = (index % 2 === 0) ? '#f9f9fc' : '#ffffff';

  const asinInfo = document.createElement('div');
  asinInfo.className = 'asin-info';

  // === Lien ASIN (ou affichage texte bleu si ThirdParty)
  const asinLink = document.createElement('a');
  const asinText = document.createElement('span');
  const marketplace = rows[0]['Input.marketplace']?.toUpperCase?.() || 'US';
  const domains = {
    IN: 'www.amazon.in', FR: 'www.amazon.fr', UK: 'www.amazon.co.uk',
    DE: 'www.amazon.de', IT: 'www.amazon.it', US: 'www.amazon.com'
  };
  const domain = domains[marketplace] || 'www.amazon.com';

  if (asin.startsWith('ThirdParty-')) {
    asinText.textContent = asin;
    asinText.style.color = "#0066cc";
    asinText.style.fontSize = "15px";
    asinInfo.appendChild(asinText);
  } else {
    asinLink.href = `https://${domain}/dp/${asin}`;
    asinLink.target = "_blank";
	asinText.textContent = asin;
	asinLink.textContent = asin;
	asinLink.style.color = "#0066cc";
    asinLink.style.fontSize = "15px";
    asinInfo.appendChild(asinLink);
	asinInfo.appendChild(asinText);
  }

  // === RÃ©cupÃ©ration des donnÃ©es pour cet ASIN
  const matches = parseFixedJSON(rows[0]['Input.matches'] || '[]');
  const asinMatch = matches.find(m => m.asin === asin);

  if (asinMatch) {
    // Affichage du titre
    if (asinMatch.product_title) {
	  allTitles.push(asinMatch.product_title);
      const title = document.createElement('div');
      title.textContent = asinMatch.product_title;
      title.style.fontSize = "15px";
      title.style.margin = "4px 0";
      asinInfo.appendChild(title);
    }

    // Affichage du lien Product URL si non vide
    if (asinMatch.product_url && asinMatch.product_url.trim() !== "") {
      const productLink = document.createElement('a');
      productLink.href = asinMatch.product_url;
      productLink.target = "_blank";
	  productLink.textContent = productLink;
      productLink.style.display = "block";
      productLink.style.fontSize = "15px";
      productLink.style.color = "#0066cc";
      productLink.style.marginBottom = "4px";
      asinInfo.appendChild(productLink);
    }

    // Affichage du lien image_url si existe
    if (asinMatch.image_url && asinMatch.image_url.trim() !== "") {
      const imageLink = document.createElement('a');
      imageLink.href = asinMatch.image_url;
      imageLink.target = "_blank";
      imageLink.textContent = "Image Link";
      //imageLink.style.display = "block";
      imageLink.style.fontSize = "18px";
      imageLink.style.color = "#0066cc";
      imageLink.style.marginBottom = "15px";
	  imageLink.style.marginLeft = "1px";
      asinInfo.appendChild(imageLink);
    }
  }
//FIN MODIFICATION ICI

  const preview = findImage(rows[0], asin);
  if (preview) {
    const img = document.createElement('img');
    img.src = preview;
    img.className = 'preview-img';
    img.onclick = () => showASINImage(preview);
    asinInfo.appendChild(img);
  }

  asinBlock.appendChild(asinInfo);

  // === GROUPAGE DES WORKERS + MAJORITÃ‰
  const grouped = groupByWorkerId(rows, asin);
  const counts = {}, responses = {};
  for (const [workerId, values] of Object.entries(grouped)) {
    const simpleKey = values.filter(v => !v.startsWith("relevance_label:")).sort().join('|');
    counts[simpleKey] = (counts[simpleKey] || 0) + 1;
    responses[workerId] = values;
  }
  const maxCount = Math.max(...Object.values(counts));
  const majorKeys = Object.keys(counts).filter(k => counts[k] === maxCount);
  const majorSimpleAttrs = majorKeys[0]?.split('|') || [];

  // === RÃ©ponse Juge
  const judgeCol = document.createElement('div');
  judgeCol.className = 'worker-column judge';
  const judgeTitle = document.createElement('div');
  judgeTitle.className = 'judge-title';
  judgeTitle.textContent = "RÃ©ponse Juge :";
  judgeCol.appendChild(judgeTitle);

  const judgeGroup = document.createElement('div');
  judgeGroup.className = 'checkbox-group';
  const storageKey = `${hitId}_${asin}`;
  const stored = savedJudgeAnswers[storageKey] || [];

  ATTRIBUTES.filter(attr => attr !== "relevance_label").forEach(attr => {
    const label = document.createElement('label');
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.name = `${asin}_${attr}`;
    cb.className = 'juge-checkbox';
    cb.value = attr;

    // coche si majoritÃ© ou dÃ©jÃ  stockÃ©
    if (stored.includes(attr) || majorSimpleAttrs.includes(attr)) cb.checked = true;

    cb.addEventListener('change', () => {
      const currentStorage = JSON.parse(localStorage.getItem("judgeAnswers") || '{}');
      const current = currentStorage[storageKey] || [];
      if (cb.checked && !current.includes(attr)) current.push(attr);
      if (!cb.checked && current.includes(attr)) current.splice(current.indexOf(attr), 1);
      currentStorage[storageKey] = current;
      localStorage.setItem("judgeAnswers", JSON.stringify(currentStorage));
    });

    label.appendChild(cb);
    label.append(` ${attr}`);
    judgeGroup.appendChild(label);
  });

  // === Calcul majorityRel AVANT affichage des Workers ===
let majorityRel = null;
if (ATTRIBUTES.includes("relevance_label")) {
  const allRelValues = Object.values(responses)
    .map(v => v.find(a => a.startsWith("relevance_label:")))
    .map(a => a ? a.split(":")[1].trim() : null)
    .filter(v => v != null);
  const relCount = {};
  allRelValues.forEach(val => relCount[val] = (relCount[val] || 0) + 1);
  const maxRel = Math.max(...Object.values(relCount));
  majorityRel = Object.keys(relCount).find(k => relCount[k] === maxRel);
}

// === RÃ©ponse juge : relevance_label
if (ATTRIBUTES.includes("relevance_label")) {
  const label = document.createElement('label');
  label.textContent = " relevance_label: ";
  label.style.display = "block";
  label.style.marginTop = "5px";

  const select = document.createElement('select');
  select.name = `${asin}_relevance_label`;

  ["", "irrelevant", "possible_substitute", "cannot_judge", "exact_match"].forEach(val => {
    const opt = document.createElement('option');
    opt.value = val;
    opt.textContent = val || "-- Choisir --";
    select.appendChild(opt);
  });

  const storedRel = stored.find(v => v.startsWith("relevance_label:"));
  select.value = storedRel ? storedRel.split(":")[1].trim() : majorityRel || "";

  select.addEventListener('change', () => {
    const currentStorage = JSON.parse(localStorage.getItem("judgeAnswers") || '{}');
    let current = currentStorage[storageKey] || [];
    current = current.filter(v => !v.startsWith("relevance_label:"));
    if (select.value) current.push(`relevance_label: ${select.value}`);
    currentStorage[storageKey] = current;
    localStorage.setItem("judgeAnswers", JSON.stringify(currentStorage));
  });

  label.appendChild(select);
  judgeGroup.appendChild(label);
}

  judgeCol.appendChild(judgeGroup);
  asinBlock.appendChild(judgeCol);

  // === Affichage des Workers
  for (const [workerId, values] of Object.entries(responses)) {
    const col = document.createElement('div');
    col.className = 'worker-column';
    col.innerHTML = `<b>${workerId}</b><br>`;

    const simpleAttrs = values.filter(v => !v.startsWith("relevance_label:")).sort();
    const relAttr = values.find(v => v.startsWith("relevance_label:"));
    const relValue = relAttr ? relAttr.split(":")[1].trim() : null;
    const simpleKey = simpleAttrs.join('|');
    const isMajor = majorKeys.includes(simpleKey);

    simpleAttrs.forEach(val => {
      const span = document.createElement('div');
      span.textContent = val;
      span.className = isMajor ? 'majority' : 'minority';
      col.appendChild(span);
    });

    if (relValue) {
      const isMajorRel = relValue === majorityRel;
      const relSpan = document.createElement('div');
      relSpan.textContent = relValue;
      relSpan.className = isMajorRel ? 'majority' : 'minority';
      relSpan.style.fontStyle = 'italic';
      col.appendChild(relSpan);
    }

    const commentBox = document.createElement('textarea');
    commentBox.rows = 2;
    commentBox.placeholder = "";
    commentBox.style.marginTop = "4px";
    commentBox.style.width = "100%";
    const commentKey = `comment_${hitId}_${asin}_${workerId}`;
    const savedComment = localStorage.getItem(commentKey);
    if (savedComment) commentBox.value = savedComment;
    commentBox.addEventListener('input', () => {
      localStorage.setItem(commentKey, commentBox.value);
    });
    col.appendChild(commentBox);

    const rowMatch = rows.find(r => r.WorkerId === workerId && parseFixedJSON(r['Answer.output_data'] || '{}')?.[asin]);
    if (rowMatch && rowMatch.AssignmentId) {
      const assignDisplay = document.createElement('div');
      assignDisplay.classList.add('hidden');
      assignDisplay.textContent = `AssignmentId: ${rowMatch.AssignmentId}`;
      assignDisplay.style.fontSize = "10px";
      assignDisplay.style.color = "#666";
      assignDisplay.style.marginTop = "3px";
      col.appendChild(assignDisplay);
    }

    asinBlock.appendChild(col);
  }
  recolorTitles(hitContainer);
  hitContainer.appendChild(asinBlock);
});

  //ato ambony ato
 // REMPLISSAGE DES INFORMATIONS NECESSAIRES
// === Mise Ã  jour des informations dans #informations ===
const infoDiv = document.getElementById("informations");
if (infoDiv) {
  const row = rows[0];
  const type = window.detectedType || 'Inconnu';
  const batch = row['Title'] || 'Non spÃ©cifiÃ©';/// AVERENO Source.name raha TSY FICHIER COMPILE TSV no atao
  const hitId = row['HITId'] || '';
  const queryURL = row['Input.imageURL'] || '';
  const textContent = row['Input.content'] || '---';
  const text = row['Input.text'] || '';
  const textURL = row['Input.textURL'] || '';
  const rawTextURL = row['Input.textURL']; // peut Ãªtre undefined, null ou "null"
  const hasTextURL = rawTextURL !== undefined && rawTextURL !== null && String(rawTextURL).trim().toLowerCase() !== 'null';
  const queryASIN = row['Input.queryProductASIN']; // ðŸ†• VÃ©rifie si la colonne existe
  //console.log(queryASIN);

  let html = `
    <b>Type :</b> ${type}<br>
    <b>Batch :</b> ${batch}<br>
    <b>HITId :</b> ${hitId}<br>
    <b>Query URL :</b> <a href="${queryURL}" target="_blank">${queryURL}</a><br>
  `;

// ðŸ†• Affichage ASIN QUERY avec gestion du cas "null" en texte
const rawQueryASIN = row['Input.queryProductASIN']; // peut Ãªtre undefined ou "null"
const hasASIN = rawQueryASIN !== undefined && rawQueryASIN !== null && String(rawQueryASIN).trim().toLowerCase() !== 'null';

if (hasASIN) {
  const queryASIN = String(rawQueryASIN).trim();
  const marketplace = String(row['Input.marketplace'] || 'US').toUpperCase();
  const domains = {
    IN: 'www.amazon.in', FR: 'www.amazon.fr', UK: 'www.amazon.co.uk',
    DE: 'www.amazon.de', IT: 'www.amazon.it', US: 'www.amazon.com'
  };
  const domain = domains[marketplace] || 'www.amazon.com';
  const asinHref = `https://${domain}/dp/${encodeURIComponent(queryASIN)}`;

  html += `<b>ASIN QUERY :</b> <a href="${asinHref}" target="_blank" rel="noopener noreferrer">${queryASIN}</a><br>`;

  const query_title = row['Input.queryProductTitle'];
  if (query_title) {
    html += `<div style="margin-left:10px; font-style:italic;">${query_title}</div>`;
  }
} else {
  html += `<b>ASIN QUERY :</b> Batch non-LMT<br>`;
}

  if (text) html += `<b>Text :</b> ${text}<br>`;

  if (textURL) {
    // tu peux rÃ©activer ici si nÃ©cessaire
    // html += `<b>Text URL :</b> <a href="${textURL}" target="_blank">${textURL}</a><br>`;
  }

  html += `<b>Input content :</b> ${textContent}<br>`;
  infoDiv.innerHTML = html;
  infoDiv.style.display = 'block';

// ðŸ†• Chargement du contenu textURL si prÃ©sent et valide
if (hasTextURL) {
  const textURL = String(rawTextURL).trim();
  fetch(textURL)
    .then(response => {
      if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
      return response.text();
    })
    .then(data => {
      const pre = document.createElement('pre');
      pre.textContent = data.slice(0, 1000);
      pre.style.maxHeight = '300px';
      pre.style.overflowY = 'auto';
      pre.style.background = '#f4f4f4';
      pre.style.border = '1px solid #ccc';
      pre.style.padding = '6px';
      pre.style.marginTop = '8px';
      pre.style.fontSize = '16px';
      pre.style.fontWeight = 'bold';
      infoDiv.appendChild(pre);
    })
    .catch(err => {
      // console.warn("âŒ Erreur lors du chargement du textURL :", err);
    });
}
}

}





//TAPITRA HATREO NY SHOW HIT id
    function findImage(row, asin) {
      try {
        const matches = parseFixedJSON(row['Input.matches'] || '[]');
        const match = matches.find(m => m.asin === asin);
        return match?.image_url && match.image_url !== 'Product not found' ? match.image_url : null;
      } catch { return null; }
    }

    function groupByWorkerId(rows, asin) {
	  const grouped = {};

	  rows.forEach(row => {
		const workerId = row.WorkerId;
		const outputData = parseFixedJSON(row['Answer.output_data'] || '{}');

		if (!outputData[asin]) return;

		const asinData = outputData[asin];
		const values = [];

		Object.entries(asinData).forEach(([key, val]) => {
		  if (val === true) {
			values.push(key);
		  } else if (key === "relevance_label" && typeof val === 'string') {
			values.push(`relevance_label: ${val}`);
		  }
		});

		grouped[workerId] = values;
	  });

  return grouped;
}
let loadedImage = null;
let currentAngle = 0;
let targetAngle = 0;
let currentScale = 1;
let isAnimating = false;

function showASINImage(src) {
  const canvas = document.getElementById("floatingASINCanvas");
  const ctx = canvas.getContext("2d");
  const img = new Image();

  img.onload = function () {
    loadedImage = img;
    currentAngle = 0;
    targetAngle = 0;
    currentScale = 1;
    resizeCanvas(canvas, img.width, img.height);
    drawImage(ctx, loadedImage, currentAngle, currentScale);
  };

  img.src = src;
  canvas.style.display = "block";

  makeDraggableAndZoomable(canvas, true);

// Zoom avec molette
canvas.onwheel = (e) => {
  e.preventDefault();

  const zoomIntensity = 0.05;  // rÃ©duit la vitesse de zoom

  // Position et taille avant zoom
  const rect = canvas.getBoundingClientRect();
  const centerX = rect.left + rect.width / 2;
  const centerY = rect.top + rect.height / 2;

  // Modification du scale
  if (e.deltaY < 0) {
    currentScale += zoomIntensity;
  } else {
    currentScale = Math.max(0.1, currentScale - zoomIntensity);
  }

  // Nouvelle taille
  const newWidth = loadedImage.width * currentScale;
  const newHeight = loadedImage.height * currentScale;

  // Redimensionne le canvas
  resizeCanvas(canvas, newWidth, newHeight);

  // Positionne le canvas pour garder le centre fixe
  canvas.style.position = 'fixed'; // important pour pouvoir ajuster left/top
  canvas.style.left = (centerX - newWidth / 2) + 'px';
  canvas.style.top = (centerY - newHeight / 2) + 'px';

  // Redessine lâ€™image aprÃ¨s mise Ã  jour visuelle
  requestAnimationFrame(() => {
    drawImage(ctx, loadedImage, currentAngle, currentScale);
  });
};



  // Rotation avec double clic (animÃ©e)
  canvas.ondblclick = () => {
    targetAngle += 90;
    if (!isAnimating) animateRotation(ctx);
  };
}

function resizeCanvas(canvas, width, height) {
  canvas.width = width;
  canvas.height = height;
}

function drawImage(ctx, img, angle, scale) {
  ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
  ctx.save();
  ctx.translate(ctx.canvas.width / 2, ctx.canvas.height / 2);
  ctx.rotate(angle * Math.PI / 180);
  ctx.scale(scale, scale);
  ctx.drawImage(img, -img.width / 2, -img.height / 2);
  ctx.restore();
}

function animateRotation(ctx) {
  isAnimating = true;
  const step = () => {
    const diff = targetAngle - currentAngle;
    if (Math.abs(diff) < 0.5) {
      currentAngle = targetAngle;
      drawImage(ctx, loadedImage, currentAngle, currentScale);
      isAnimating = false;
      return;
    }
    currentAngle += diff * 0.1; // interpolation douce
    drawImage(ctx, loadedImage, currentAngle, currentScale);
    requestAnimationFrame(step);
  };
  step();
}

function makeDraggableAndZoomable(canvas, escapable) {
  let isDragging = false, startX, startY;
  canvas.addEventListener('mousedown', e => {
    isDragging = true;
    startX = e.clientX - canvas.offsetLeft;
    startY = e.clientY - canvas.offsetTop;
    canvas.style.cursor = 'grabbing';
    e.preventDefault();
  });
  document.addEventListener('mousemove', e => {
    if (!isDragging) return;
    canvas.style.left = `${e.clientX - startX}px`;
    canvas.style.top = `${e.clientY - startY}px`;
  });
  document.addEventListener('mouseup', () => {
    isDragging = false;
    canvas.style.cursor = 'move';
  });
  canvas.addEventListener('wheel', e => {
    e.preventDefault();
    currentScale *= e.deltaY < 0 ? 1.1 : 0.9;
    redrawCanvas(canvas, currentAngle, currentScale);
  });
  if (escapable) {
    document.addEventListener('keydown', e => {
      if (e.key === "Escape") canvas.style.display = "none";
      if (e.key === "ArrowLeft") { currentAngle -= 5; redrawCanvas(canvas, currentAngle, currentScale); }
      if (e.key === "ArrowRight") { currentAngle += 5; redrawCanvas(canvas, currentAngle, currentScale); }
    });
  }
}

function redrawCanvas(canvas, angle, scale) {
  if (!loadedImage) return; // pas d'image chargÃ©e => rien faire
  const ctx = canvas.getContext("2d");
  drawImage(ctx, loadedImage, angle, scale);
}
	
	
	
	
	/**
 * Corrige une chaÃ®ne JSON en entourant les clÃ©s numÃ©riques longues par des guillemets.
 * Exemple : {1077129068: {...}} => {"1077129068": {...}}
 * @param {string} jsonString - ChaÃ®ne JSON potentiellement mal formÃ©e.
 * @returns {object|null} - Objet JSON corrigÃ©, ou null si erreur.
 */
function parseFixedJSON(jsonString) {
  try {
    // Remplace les clÃ©s numÃ©riques non-quotÃ©es par des clÃ©s entre guillemets
    const fixed = jsonString.replace(/([{,])(\d{7,})(?=\s*:)/g, '$1"$2"');
    return JSON.parse(fixed);
  } catch (e) {
    console.warn("Erreur lors du parsing JSON corrigÃ© :", e);
    return null;
  }
}

//ROTATION ET DEPLACEMENT IMAGE QUERY
function enableRotationOnWrapper(wrapperId) {
  const wrapper = document.getElementById(wrapperId);
  if (!wrapper) return;

  wrapper.dataset.rotation = wrapper.dataset.rotation || "0";

  wrapper.addEventListener('dblclick', () => {
    const current = parseFloat(wrapper.dataset.rotation) || 0;
    wrapper.dataset.rotation = current + 90;

    wrapper.style.transition = 'transform 0.3s ease';
    applyTransform(wrapper);

    // Supprimer la transition aprÃ¨s pour Ã©viter qu'elle sâ€™applique au drag/zoom
    setTimeout(() => wrapper.style.transition = '', 300);
  });
}

//ROTATION ET DEPLACEMENT IMAGE ASIN
function enableImageRotation(imgId) {
  const img = document.getElementById(imgId);
  if (!img) return;

  img.dataset.rotation = img.dataset.rotation || "0";

  img.addEventListener('dblclick', () => {
    const current = parseFloat(img.dataset.rotation) || 0;
    img.dataset.rotation = current + 90;

    img.style.transition = 'transform 0.3s ease';
    applyTransform(img);

    setTimeout(() => img.style.transition = '', 300);
  });
}

//FONCTION DRESSAGE TABLEAU RESULTAT
document.getElementById('btnSaveData').addEventListener('click', async () => {
  const asinBlocks = document.querySelectorAll('.asin-block');
  const tableau = document.getElementById('tableauResultat');
  const tbody = tableau.querySelector('tbody');
  tbody.innerHTML = '';

  if (!currentHitRow) {
    alert("â— Erreur : aucune donnÃ©e HIT disponible.");
    return;
  }

  let erreurs = [];
  const assignments = {};

  asinBlocks.forEach(asinBlock => {
    const asinKey = asinBlock.querySelector('.asin-info span')?.textContent.trim().replace("ASIN:", "").trim() || '[ASIN inconnu]';
	//const asinKey = asinBlock.getAttribute('data-asin') || '[ASIN inconnu]';
	if (!asinKey || asinKey === '[ASIN inconnu]') {
  console.warn("âš ï¸ ASIN manquant dans le bloc :", asinBlock);
}
	

    // âœ… RÃ©cupÃ©rer les valeurs cochÃ©es (checkboxes) et relevance_label
	const jugeColumn = asinBlock.querySelector('.worker-column.judge');
	let jugeCheckedValues = [];

	if (jugeColumn) {
	  const jugeCheckboxes = jugeColumn.querySelectorAll('input.juge-checkbox:checked');
	  jugeCheckedValues = Array.from(jugeCheckboxes).map(cb => cb.value);

	  // ðŸ›  SÃ©lecteur dynamique pour relevance_label
	  const relevanceSelect = jugeColumn.querySelector(`select[name="${asinKey}_relevance_label"]`);
	  if (relevanceSelect && relevanceSelect.value && relevanceSelect.value !== 'none') {
		jugeCheckedValues.push(relevanceSelect.value);
	  }
	} else {
	  console.warn(`âš ï¸ Colonne .worker-column.judge introuvable pour ASIN ${asinKey}`);
	}

	// âœ… Debug
	//console.log(`ðŸ” ASIN: ${asinKey}`);
	//console.log(`ðŸ“Œ Jugement du juge:`, jugeCheckedValues);

    if (jugeCheckedValues.length === 0) {
      erreurs.push(`${asinKey} (aucun verdict cochÃ©)`);
      return;
    }

    const workerCols = asinBlock.querySelectorAll('.worker-column:not(.judge)');

    workerCols.forEach(col => {
      const workerId = col.querySelector('b')?.textContent.trim() || '[workerId inconnu]';

      const assignmentDiv = Array.from(col.querySelectorAll('div')).find(d => d.textContent.includes('AssignmentId:'));
      const assignmentId = assignmentDiv ? assignmentDiv.textContent.replace('AssignmentId:', '').trim() : '';

      const commentText = col.querySelector('textarea')?.value.trim() || '';

      if (!workerId || !assignmentId) {
        erreurs.push(`${asinKey} / ${workerId} (manque workerId ou assignmentId)`);
        return;
      }

      if (!assignments[assignmentId]) assignments[assignmentId] = [];

      const assinJson = Array.from(col.querySelectorAll('.majority, .minority'))
        .map(d => d.textContent.trim())
        .filter(Boolean)
        .join(', ');

      assignments[assignmentId].push({
        asinKey,
        assignmentId,
        workerId,
        jugeCheckedValues,
        commentText,
        assinJson,
        block: asinBlock
      });
    });
  });

  if (erreurs.length > 0) {
    alert("âš ï¸ Il y a " + erreurs.length + " erreur(s) :\n\n" + erreurs.join('\n'));
    return;
  }

  for (const [assignmentId, items] of Object.entries(assignments)) {
    items.forEach(item => {
      const {
        asinKey,
        assignmentId,
        workerId,
        jugeCheckedValues,
        commentText,
        assinJson,
        block
      } = item;

      const hitId = currentHitRow['HITId'] || 'inconnu';
      const inputImageURL = currentHitRow['Input.imageURL'] || '';
      const inputBBox = currentHitRow['Input.bbox'] || '';
      const inputContent = currentHitRow['Input.content'] || '';
      const answerOutput = currentHitRow['Answer.output_data'] || '';
      const inputMatches = currentHitRow['Input.matches'] || '{}';
      const marketplace = currentHitRow['Input.marketplace'] || '';

      let amazonImage = '';
try {
  const matchArray = JSON.parse(inputMatches);
  const asinMatch = matchArray.find(m => m.asin === asinKey);

  // ðŸ” Ajout des logs pour dÃ©bogage
  //console.log('ðŸ” asinMatch =', asinMatch);
  if (asinMatch) {
    //console.log('ðŸ“¸ asinMatch.image_url =', asinMatch.image_url);
  } else {
    //console.log('âŒ Aucun asinMatch trouvÃ© pour asinKey =', asinKey);
  }

  if (asinMatch && asinMatch.image_url) {
    amazonImage = asinMatch.image_url;
  }
} catch (e) {
  console.warn(`âŒ Erreur parsing matches pour ASIN ${asinKey}`, e);
  //alert("ato ve zany");
}

      const row = document.createElement('tr');
      [
        hitId,
        assignmentId,
        workerId,
        inputImageURL,
        inputBBox,
        inputContent,
        answerOutput,
        amazonImage,
        marketplace,
        inputMatches,
        asinKey,
        assinJson,
        jugeCheckedValues.join(','),
        commentText
      ].forEach(val => {
        const td = document.createElement('td');
        td.textContent = val;
        row.appendChild(td);
      });

      tbody.appendChild(row);
    });
  }

  tableau.style.display = 'none';
  gotosheet(); // ðŸš€ Lance l'enregistrement
});



async function gotosheet() {
  const sheetUrlInput = document.getElementById('sheetUrlInput');
  const sheetUrl = sheetUrlInput.value.trim();

  if (!sheetUrl.startsWith('https://docs.google.com/spreadsheets/')) {
    alert('âŒ Tsy valide ilay Sheet nomenao na tsisy onglet Details ASIN, sa ahoana hozy Enao?');
    return;
  }

  if (!currentHitRow || !currentHitRow['HITId']) {
    alert('âŒ Misy tsy ampy ny donnÃ©es hadika, sa ahoana hozy enao?');
    return;
  }

  const hitId = currentHitRow['HITId'];

  const tableau = document.getElementById('tableauResultat');
  if (!tableau) {
    alert('âŒ Tsy hita mihintsy ilay tableau, sa ahoana hozy enao?');
    return;
  }

  const rows = tableau.querySelectorAll('tbody tr');
  if (rows.length === 0) {
    alert('âŒ Vide ilay tableau, sa ahoana hozy enao?');
    return;
  }

  // Ã‰tape 1 â€“ VÃ©rification d'existence
	const gasWebAppUrl = document.getElementById("automatisme").value.trim() || localStorage.getItem("gas_webapp_url");

	if (!gasWebAppUrl || !gasWebAppUrl.startsWith("https://script.google.com/macros/")) {
	  alert("âŒ Tsy norma ilay URL automatisme nomena sa ahoana hozy Enao?.");
	  throw new Error("ClÃ© GAS invalide ou manquante");
	}

const checkUrl = `${gasWebAppUrl}?sheetUrl=${encodeURIComponent(sheetUrl)}&hitId=${encodeURIComponent(hitId)}`;

  let overwrite = false;
  let overwriteRange = null;

  try {
    const response = await fetch(checkUrl);
    const result = await response.json();

    if (result.status === "success" && result.found) {
      const confirmation = confirm(`âš ï¸ HITId efa traitÃ© io ary ato  (${result.range}). Sa ahoana hozy Enao, Ecrasena ve sa Tsia ?`);
      if (!confirmation) {
        // OpÃ©ration annulÃ©e par lâ€™utilisateur
        return;
      }
      overwrite = true;
      overwriteRange = result.range;
    }
  } catch (err) {
    alert('âŒ Erreur lors de la vÃ©rification de doublon : ' + err.message);
	scrollPageToTop(); // ici on scrolle vers le haut
    return;
  }

  // Ã‰tape 2 â€“ Construction des donnÃ©es Ã  envoyer (sans entÃªte)
  const dataToSend = [];
  rows.forEach(tr => {
    const rowData = [];
    tr.querySelectorAll('td').forEach(td => {
      rowData.push(td.textContent.trim());
    });
    dataToSend.push(rowData);
  });

  // Ã‰tape 3 â€“ Envoi silencieux vers Apps Script
  //const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby9ggWBwFGM8i0lFByZpaYBdoeEW3uSK1SLHr1zpUCZCfaqLnROmd3a0ac6BX3ffoMLaA/exec';
  const GAS_WEB_APP_URL = localStorage.getItem("gas_webapp_url");

  fetch(GAS_WEB_APP_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      sheetUrl,
      hitId,
      data: dataToSend,
      range: overwrite ? overwriteRange : null
    })
  });

  // Affichage du sablier avec progression modale
  const overlay = document.getElementById('progressOverlay');
  const progressText = document.getElementById('progressText');
  overlay.style.display = 'flex';

  // Progression simulÃ©e
  const Ã©tapes = [1, 10, 20, 35, 45, 60, 75, 85, 95, 99];
  for (let i = 0; i < Ã©tapes.length; i++) {
    progressText.textContent = `VÃ©rification en cours... ${Ã©tapes[i]}%`;
    await new Promise(resolve => setTimeout(resolve, 200)); // DÃ©lai ajustable
  }

  // Ã‰tape 4 â€“ VÃ©rification finale aprÃ¨s progression
  try {
    const check = await fetch(checkUrl);
    const result = await check.json();

    if (result.status === 'success' && result.found) {
      progressText.innerHTML = '<span class="icon">âœ…</span> Details ASIN OK!.';
    } else {
      progressText.innerHTML = '<span class="icon">âš ï¸</span> DÃ©tails ASIN OK!';
    }
  } catch (err) {
    progressText.innerHTML = 'âŒ Erreur lors de la vÃ©rification finale : ' + err.message;
  }

  // Attente pour afficher le message final, puis fermeture de l'overlay
  await new Promise(resolve => setTimeout(resolve, 1000));
  overlay.style.display = 'none';
  scrollPageToTop(); // ici on scrolle vers le haut

}



// CODE DE TEST POUR LA VERIFICATION EXISTANCE DANS DETAILS asin
document.getElementById("verifierdata").addEventListener("click", async () => {
  const hitId = document.getElementById("hitIdInput").value.trim();
  const sheetUrl = document.getElementById("sheetUrlInput").value.trim(); // ðŸŸ¢ correction ici

  if (!sheetUrl.startsWith('https://docs.google.com/spreadsheets/')) {
    return alert("âŒ Na tsisy Details ASIN na tsy norma le Sheet picking sa ahoana hozy Enao?.");
  }

  if (!hitId) {
    return alert("Fa aiza ze HitID sa ahoana hozy Enao?");
  }

  const gasWebAppUrl = document.getElementById("automatisme").value.trim() || localStorage.getItem("gas_webapp_url");
	if (!gasWebAppUrl) {
	  alert("âŒ Ampidiro aloha le URL Script automatisme sa ahoana hozy Enao?.");
	  throw new Error("GAS Web App URL manquant");
	}

const apiUrl = `${gasWebAppUrl}?sheetUrl=${encodeURIComponent(sheetUrl)}&hitId=${encodeURIComponent(hitId)}`;


  try {
    const response = await fetch(apiUrl);
    const result = await response.json();

    const msg = document.getElementById("verifMessage");
    if (result.status === "success") {
      msg.textContent = result.found
        ? "âœ… Oui, ce HitID est dÃ©jÃ  traitÃ©"
        : "âŒ Non, ce HitID n'est pas encore traitÃ©";
      msg.style.color = result.found ? "green" : "red";

      // âœ… Facultatif : on peut dÃ©clencher automatiquement le chargement des rÃ©sultats ici
      if (result.found) {
        //loadSheetResults(hitId);
      }

    } else {
      msg.textContent = "âš ï¸ Erreur: " + result.message;
      msg.style.color = "orange";
    }
  } catch (err) {
    console.error("Erreur de requÃªte :", err);
    document.getElementById("verifMessage").textContent = "âš ï¸ Erreur rÃ©seau ou script.";
  }
});





window.addEventListener('DOMContentLoaded', () => {
  // Masquer le sablier
  const overlay = document.getElementById('progressOverlay');
  if (overlay) overlay.style.display = 'none';

  // ðŸ”¹ GÃ©rer l'input #automatisme (clÃ© : gas_webapp_url)
  const input = document.getElementById("automatisme");
  const savedUrl = localStorage.getItem("gas_webapp_url");
  if (savedUrl) input.value = savedUrl;

  input.addEventListener("input", () => {
    const url = input.value.trim();
    localStorage.setItem("gas_webapp_url", url);
  });

  // ðŸ”¹ GÃ©rer l'input #sheetUrlInput (clÃ© : last_URL_Sheet_DA)
  const sheetUrlInput = document.getElementById("sheetUrlInput");
  const savedSheetUrl = localStorage.getItem("last_URL_Sheet_DA");
  if (savedSheetUrl) sheetUrlInput.value = savedSheetUrl;

  sheetUrlInput.addEventListener("input", () => {
    localStorage.setItem("last_URL_Sheet_DA", sheetUrlInput.value.trim());
  });
});

  
  
 //CHARGEMENT DE URL DE DEPLOYEMENT POUR CHAQUE utilisateur
 window.onload = () => {
  const savedUrl = localStorage.getItem("gas_webapp_url");
  if (savedUrl) {
    document.getElementById("automatisme").value = savedUrl;
  }

  document.getElementById("automatisme").addEventListener("change", () => {
    const url = document.getElementById("automatisme").value.trim();
    localStorage.setItem("gas_webapp_url", url);
  });
};


function showNotification(message) {
  const notif = document.getElementById('notification');
  notif.textContent = message;
  notif.classList.add('show');
  setTimeout(() => {
    notif.classList.remove('show');
  }, 3000);  // disparition aprÃ¨s 3000 ms = 3 secondes
}

document.getElementById("btnSaveData1").addEventListener("click", () => {
  document.getElementById("btnSaveData").click();
});


document.addEventListener("DOMContentLoaded", () => {
  const controls = document.getElementById("controls");
  const toggleBtn = document.getElementById("toggleControlsBtn");

  toggleBtn.addEventListener("click", () => {
    controls.classList.toggle("hidden");
    toggleBtn.textContent = controls.classList.contains("hidden") ? "â–¼" : "â–²";
  });
});



document.getElementById("hitIdInput").addEventListener("keydown", function (event) {
  if (event.key === "Enter") {
    const hitId = this.value.trim();
    if (hitId) {
      showHIT(hitId);
    }
  }
});



//ELEMENT INTERACT JS
interact('#floatingQueryWrapper')
  .draggable({
    listeners: {
      start(event) {
        event.target.classList.add('dragging');
      },
      move(event) {
        const target = event.target;

        // Lire les valeurs existantes ou mettre par dÃ©faut
        const x = (parseFloat(target.dataset.x) || 0) + event.dx;
        const y = (parseFloat(target.dataset.y) || 0) + event.dy;
        const scale = parseFloat(target.dataset.scale) || 1;
        const rotation = parseFloat(target.dataset.rotation) || 0;

        // Sauvegarder les nouvelles coordonnÃ©es
        target.dataset.x = x;
        target.dataset.y = y;

        // Appliquer les 3 transformations sans perte
        target.style.transform = `translate(${x}px, ${y}px) scale(${scale}) rotate(${rotation}deg)`;
      },
      end(event) {
        event.target.classList.remove('dragging');
      }
    }
  })
  .gesturable({
    listeners: {
      move (event) {
        const target = event.target;

        const currentRotation = parseFloat(target.dataset.rotation) || 0;
        const newRotation = currentRotation + event.da;

        const currentScale = parseFloat(target.dataset.scale) || 1;
        const newScale = Math.min(Math.max(currentScale * (1 + event.ds), 0.5), 3);

        const x = parseFloat(target.getAttribute('data-x')) || 0;
        const y = parseFloat(target.getAttribute('data-y')) || 0;

        target.style.transform = `translate(${x}px, ${y}px) rotate(${newRotation}deg) scale(${newScale})`;

        target.dataset.rotation = newRotation;
        target.dataset.scale = newScale;
      }
    }
  });
  
  function applyTransform(el) {
  const x = parseFloat(el.dataset.x) || 0;
  const y = parseFloat(el.dataset.y) || 0;
  const scale = parseFloat(el.dataset.scale) || 1;
  const rotation = parseFloat(el.dataset.rotation) || 0;

  el.style.transform = `translate(${x}px, ${y}px) scale(${scale}) rotate(${rotation}deg)`;
}

// Initialiser les datas sur le wrapper
function initializeWrapper(wrapperId) {
  const wrapper = document.getElementById(wrapperId);
  if (!wrapper) return;

  wrapper.dataset.x = "0";
  wrapper.dataset.y = "0";
  wrapper.dataset.scale = "1";
  wrapper.dataset.rotation = "0";
  applyTransform(wrapper);
}

// Rotation sur double-clic
function enableRotationOnWrapper(wrapperId) {
  const wrapper = document.getElementById(wrapperId);
  if (!wrapper) return;

  wrapper.addEventListener('dblclick', () => {
    const current = parseFloat(wrapper.dataset.rotation) || 0;
    wrapper.dataset.rotation = current + 90;

    wrapper.style.transition = 'transform 0.3s ease';
    applyTransform(wrapper);

    setTimeout(() => {
      wrapper.style.transition = '';
    }, 300);
  });
}

// Rotation image seule (ASIN par exemple)
function enableImageRotation(imgId) {
  const img = document.getElementById(imgId);
  if (!img) return;

  img.dataset.rotation = "0";

  img.addEventListener('dblclick', () => {
    const current = parseFloat(img.dataset.rotation) || 0;
    img.dataset.rotation = current + 90;

    img.style.transition = 'transform 0.3s ease';
    img.style.transform = `rotate(${img.dataset.rotation}deg)`;
    img.style.transformOrigin = 'center center';

    setTimeout(() => {
      img.style.transition = '';
    }, 300);
  });
}

// Activer interact.js
function enableInteractOnWrapper(wrapperId) {
  const wrapper = document.getElementById(wrapperId);
  if (!wrapper) return;

  interact(wrapper)
    .draggable({
      listeners: {
        move(event) {
          const target = event.target;
          const dx = event.dx;
          const dy = event.dy;

          const x = (parseFloat(target.dataset.x) || 0) + dx;
          const y = (parseFloat(target.dataset.y) || 0) + dy;

          target.dataset.x = x;
          target.dataset.y = y;

          applyTransform(target);
        }
      }
    })
    .gesturable({
      listeners: {
        move(event) {
          const target = event.target;

  let x = (parseFloat(target.dataset.x) || 0) + event.dx;
  let y = (parseFloat(target.dataset.y) || 0) + event.dy;

  target.dataset.x = x;
  target.dataset.y = y;

  target.style.transform = `translate(${x}px, ${y}px)`;
        }
      }
    });
}

// === APPELS INIT ===
initializeWrapper('floatingQueryWrapper');
enableRotationOnWrapper('floatingQueryWrapper');
enableImageRotation('floatingASINImage');
enableInteractOnWrapper('floatingQueryWrapper');


//AFFICHER MASQUER INPUT SUR LE top
document.addEventListener('keydown', function (event) {
  if (event.key === 'Escape') {
    const controls = document.getElementById('controls');
    const isHidden = window.getComputedStyle(controls).display === 'none';
    controls.style.display = isHidden ? 'block' : 'none';
  }
});

//FONCTION RECOLORIAGE TITRE
function recolorTitles(container) {
  if (!container) {
    console.warn('container is undefined in recolorTitles');
    return;
  }
  if (allTitles.length === 0) return;

  const tokenizedTitles = allTitles.map(title =>
    title.toLowerCase().match(/\b[\w\d\.]+\b/g) || []
  );

  function intersection(arrays) {
    return arrays.reduce((a, b) => a.filter(c => b.includes(c)));
  }

  const commonWords = intersection(tokenizedTitles);
  if (commonWords.length === 0) return;

  // SÃ©lectionne tous les div titres dans le container
  const titleDivs = container.querySelectorAll('.asin-info > div');
  titleDivs.forEach((div, i) => {
    div.innerHTML = highlightCommonWords(allTitles[i], commonWords);
  });
}

function highlightCommonWords(title, commonWords) {
  if (commonWords.length === 0) return title;
  const regex = new RegExp(`\\b(${commonWords.join('|')})\\b`, 'gi');
  return title.replace(regex, match => `<span style="background: #FFEB3B; border-bottom: 2px solid #FBC02D;">${match}</span>`);
}


//ENREGISTREMENT TSOTRA
//FONCTION DRESSAGE TABLEAU RESULTAT
document.getElementById('done').addEventListener('click', async () => {
  const asinBlocks = document.querySelectorAll('.asin-block');
  const tableau = document.getElementById('tableauResultat');
  const tbody = tableau.querySelector('tbody');
  tbody.innerHTML = '';

  if (!currentHitRow) {
    alert("â— Erreur : aucune donnÃ©e HIT disponible.");
    return;
  }

  let erreurs = [];
  const assignments = {};

  asinBlocks.forEach(asinBlock => {
    const asinKey = asinBlock.querySelector('.asin-info span')?.textContent.trim().replace("ASIN:", "").trim() || '[ASIN inconnu]';
	//const asinKey = asinBlock.getAttribute('data-asin') || '[ASIN inconnu]';
	if (!asinKey || asinKey === '[ASIN inconnu]') {
  console.warn("âš ï¸ ASIN manquant dans le bloc :", asinBlock);
}
	

    // âœ… RÃ©cupÃ©rer les valeurs cochÃ©es (checkboxes) et relevance_label
	const jugeColumn = asinBlock.querySelector('.worker-column.judge');
	let jugeCheckedValues = [];

	if (jugeColumn) {
	  const jugeCheckboxes = jugeColumn.querySelectorAll('input.juge-checkbox:checked');
	  jugeCheckedValues = Array.from(jugeCheckboxes).map(cb => cb.value);

	  // ðŸ›  SÃ©lecteur dynamique pour relevance_label
	  const relevanceSelect = jugeColumn.querySelector(`select[name="${asinKey}_relevance_label"]`);
	  if (relevanceSelect && relevanceSelect.value && relevanceSelect.value !== 'none') {
		jugeCheckedValues.push(relevanceSelect.value);
	  }
	} else {
	  console.warn(`âš ï¸ Colonne .worker-column.judge introuvable pour ASIN ${asinKey}`);
	}

	// âœ… Debug
	//console.log(`ðŸ” ASIN: ${asinKey}`);
	//console.log(`ðŸ“Œ Jugement du juge:`, jugeCheckedValues);

    if (jugeCheckedValues.length === 0) {
      erreurs.push(`${asinKey} (aucun verdict cochÃ©)`);
      return;
    }

    const workerCols = asinBlock.querySelectorAll('.worker-column:not(.judge)');

    workerCols.forEach(col => {
      const workerId = col.querySelector('b')?.textContent.trim() || '[workerId inconnu]';

      const assignmentDiv = Array.from(col.querySelectorAll('div')).find(d => d.textContent.includes('AssignmentId:'));
      const assignmentId = assignmentDiv ? assignmentDiv.textContent.replace('AssignmentId:', '').trim() : '';

      const commentText = col.querySelector('textarea')?.value.trim() || '';

      if (!workerId || !assignmentId) {
        erreurs.push(`${asinKey} / ${workerId} (manque workerId ou assignmentId)`);
        return;
      }

      if (!assignments[assignmentId]) assignments[assignmentId] = [];

      const assinJson = Array.from(col.querySelectorAll('.majority, .minority'))
        .map(d => d.textContent.trim())
        .filter(Boolean)
        .join(', ');

      assignments[assignmentId].push({
        asinKey,
        assignmentId,
        workerId,
        jugeCheckedValues,
        commentText,
        assinJson,
        block: asinBlock
      });
    });
  });

  if (erreurs.length > 0) {
    alert("âš ï¸ Il y a " + erreurs.length + " erreur(s) :\n\n" + erreurs.join('\n'));
    return;
  }

  for (const [assignmentId, items] of Object.entries(assignments)) {
    items.forEach(item => {
      const {
        asinKey,
        assignmentId,
        workerId,
        jugeCheckedValues,
        commentText,
        assinJson,
        block
      } = item;

      const hitId = currentHitRow['HITId'] || 'inconnu';
      const inputImageURL = currentHitRow['Input.imageURL'] || '';
      const inputBBox = currentHitRow['Input.bbox'] || '';
      const inputContent = currentHitRow['Input.content'] || '';
      const answerOutput = currentHitRow['Answer.output_data'] || '';
      const inputMatches = currentHitRow['Input.matches'] || '{}';
      const marketplace = currentHitRow['Input.marketplace'] || '';

      let amazonImage = '';
try {
  const matchArray = JSON.parse(inputMatches);
  const asinMatch = matchArray.find(m => m.asin === asinKey);

  // ðŸ” Ajout des logs pour dÃ©bogage
  //console.log('ðŸ” asinMatch =', asinMatch);
  if (asinMatch) {
    //console.log('ðŸ“¸ asinMatch.image_url =', asinMatch.image_url);
  } else {
    //console.log('âŒ Aucun asinMatch trouvÃ© pour asinKey =', asinKey);
  }

  if (asinMatch && asinMatch.image_url) {
    amazonImage = asinMatch.image_url;
  }
} catch (e) {
  console.warn(`âŒ Erreur parsing matches pour ASIN ${asinKey}`, e);
}

      const row = document.createElement('tr');
      [
        hitId,
        assignmentId,
        workerId,
        inputImageURL,
        inputBBox,
        inputContent,
        answerOutput,
        amazonImage,
        marketplace,
        inputMatches,
        asinKey,
        assinJson,
        jugeCheckedValues.join(','),
        commentText
      ].forEach(val => {
        const td = document.createElement('td');
        td.textContent = val;
        row.appendChild(td);
      });

      tbody.appendChild(row);
    });
  }

  tableau.style.display = 'none';
  // SÃ©lectionner uniquement le tbody du tableau (les lignes de donnÃ©es sans l'en-tÃªte)
//const tbody = tableau.querySelector('tbody');
const range = document.createRange();
range.selectNodeContents(tbody); // on sÃ©lectionne uniquement le contenu de tbody

// Vider les sÃ©lections prÃ©cÃ©dentes puis sÃ©lectionner ce range
const selection = window.getSelection();
selection.removeAllRanges();
selection.addRange(range);

// Copier dans le presse-papiers
  const successful = document.execCommand('copy');
  if (successful) {
  showNotification('âœ… Jugement terminÃ©, rÃ©sultats copiÃ©s dans le presse-papiers.');
  scrollPageToTop(); // ici on scrolle vers le haut
} else {
  alert('âŒ Ã‰chec de la copie automatique. Veuillez copier manuellement.');
}

// Nettoyer la sÃ©lection (optionnel)
selection.removeAllRanges();
});


//SIMULATION BOUTON TERMINE SIMPLE (DU BAS)
document.getElementById('btnSaveData2').addEventListener('click', () => {
  document.getElementById('done').click();
});

//SCROOL VERS LE top
function scrollPageToTop() {
  window.scrollTo({
    top: 0,
    behavior: 'smooth' // effet de dÃ©filement fluide
  });
}

  </script>
</html>